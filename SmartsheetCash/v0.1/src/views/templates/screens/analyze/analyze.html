{% extends enums.Template.LAYOUT %}
{% block title %}
	Analyze
{% endblock title %}

{% set unuse = ctrl_obj.get_setting() %}
{% set all_settings = ctrl_obj.all_settings %}
{% set analyze_info = ctrl_obj.get_analyze_result() %}
{% block option %}
 	{% set href_prefix = enums.Route.LOAD_FILE + '?' + enums.MethodKeys.PATH + '=' + ctrl_obj.working_path + '/' + enums.StructureKeys.PARSE_FOLDER + '/' %}
	{{button({
		'type': 'button',
		'text': "Add To Smartsheet",
		'class': 'custom-button add-to-smartsheet d-inline-block',
		'href': '#',
		'attrs': [('data-sheet-id', analyze_info['result']['data']['src_id']), 
				('data-des-id', analyze_info['result']['data']['des_id'])]
		})
	}}
	{{button({
		'type': 'link',
		'text': "SRC Raw Data",
		'class': 'custom-button  d-inline-block',
		'href': href_prefix + analyze_info['result']['data']['src_id'] | string + '_parse_rows.html',
		'attrs': [('target', '_blank')]
		})
	}}
	{{button({
		'type': 'link',
		'text': "SRC Skip Row",
		'class': 'custom-button  d-inline-block',
		'href': href_prefix + analyze_info['result']['data']['src_id'] | string + '_skip_rows.html',
		'attrs': [('target', '_blank')]
		})
	}}
	{{button({
		'type': 'link',
		'text': "DES Raw Data",
		'class': 'custom-button  d-inline-block',
		'href': href_prefix + analyze_info['result']['data']['des_id'] | string + '_parse_rows.html',
		'attrs': [('target', '_blank')]
		})
	}}
	{{button({
		'type': 'link',
		'text': "DES Skip Row",
		'class': 'custom-button  d-inline-block',
		'href': href_prefix + analyze_info['result']['data']['des_id'] | string + '_skip_rows.html',
		'attrs': [('target', '_blank')]
		})
	}}
	
{% endblock option %}

{% block breadcrumb_block %}
	{% set data = {
		'items_data': [
			(enums.Route.ANALYZE, analyze_info['result']['data']['src_name'] + ' vs ' + analyze_info['result']['data']['des_name'], True)
		],
		'home_link':  enums.Route.INDEX
	}
	%}
	{{ breadcrumb(data) }}
{% endblock breadcrumb_block %}

{% block scripts %}
	{{super()}}
	<script src="{{url_for('static', filename='js/screens/analyze.js')}}"></script>
{% endblock scripts %}

{% block styles %}
	{{super()}}
	<link rel="stylesheet" href="{{ url_for('static', filename='css/screens/analyze.css') }}" />
{% endblock styles %}



{% block content %}
	<table class="table table-striped table-bordered position-relative" cellspacing="0" width='100%'>
	  <thead class="custom-position-sticky">
	    <tr>
			<th class="custom-w-3 center-text" rowspan='2'>{{checkbox({
				'value': "",
				'class': 'custom-checkbox all-checkbox',
				'attrs': [('data-target', 'tbody')],
				'text': '',
				'id': '',
				})
			}}
			</th>
				
			{% for header in all_settings[enums.ConfigKeys.SRC_COMPARE_HEADERS] %}
				<th rowspan='2' class='center-text'>{{header}}</th>
			{% endfor %}

			<th colspan='{{ 1 + all_settings[enums.ConfigKeys.SRC_CHECK_MODIFIED_HEADERS] | length }}' class='center-text'>{{analyze_info['result']['data']['src_name']}}</th>
			<th colspan='{{ 1 + all_settings[enums.ConfigKeys.DES_CHECK_MODIFIED_HEADERS] | length }}' class='center-text'>{{analyze_info['result']['data']['des_name']}}</th>	
			<th rowspan='2' class='center-text'>Status</th>
	    </tr>
		<tr>
			<th  class='center-text'>Attachments</th>
			{% for header in all_settings[enums.ConfigKeys.SRC_CHECK_MODIFIED_HEADERS] %}
				<th  class='center-text'>{{header}}</th>
			{% endfor %}
			<th  class='center-text'>Attachments</th>
			{% for header in all_settings[enums.ConfigKeys.DES_CHECK_MODIFIED_HEADERS] %}
				<th  class='center-text'>{{header}}</th>
			{% endfor %}
			
	    </tr>
	  </thead>
	  <tbody>
		  {% for status in analyze_info['result']['data'] %}
		  	{% if status in [enums.DataKeys.NEW, enums.DataKeys.MISSING, enums.DataKeys.MODIFIED, enums.DataKeys.UNCHANGED] %}
				{% for index_compare in analyze_info['result']['data'][status] %}
					{% set row = analyze_info['result']['data'][status][index_compare] %}
					{% set compare_key = row[0] %}
					{% set src_data = row[1] %}
					{% set des_data = row[2] %}
					{% set data = src_data %}
					{% set headers = all_settings[enums.ConfigKeys.SRC_COMPARE_HEADERS] %}
					{% if status == enums.DataKeys.MISSING %}
						{% set data = des_data %}
						{% set headers = all_settings[enums.ConfigKeys.DES_COMPARE_HEADERS] %}
					{% endif %}
					<tr>
						<td class="center-text">
							{{checkbox({
								'value': index_compare,
								'class': 'custom-checkbox',
								'text': '',
								'attrs': [('data-status', status), ('data-index', index_compare)]
								})
							}}
						</td>
						{% for header in headers %}
							{% set header = utils.convert_text(header) %}
							<td>{{data[header]['value']}}</td>
						{% endfor %}
						<!-- src -->
						<td><span class=''>{{src_data['attachments_name'] | join('<br>')  | safe }}</span></td>
						{% for header in all_settings[enums.ConfigKeys.SRC_CHECK_MODIFIED_HEADERS] %}
							{% set header = utils.convert_text(header) %}
							{% if src_data %}
								<td  class=''>{{src_data[header]['value']}}</td>
							{% else %}
								<td  class=''></td>
							{% endif %}
						{% endfor %}

						<!-- des -->
						<td><span class=''>{{des_data['attachments_name'] | join('<br>') | safe }}</span></td>
						{% for header in all_settings[enums.ConfigKeys.DES_CHECK_MODIFIED_HEADERS] %}
							{% set header = utils.convert_text(header) %}
							{% if des_data %}
								<td  class=''>{{des_data[header]['value']}}</td>
							{% else %}
								<td  class=''></td>
							{% endif %}
						{% endfor %}

						<td><span class='{{status}}'>{{status}}</span></td>
					</tr>
				{% endfor %}
			{% endif %}
		  {% endfor %}
		

	  </tbody>
	  
	</table>
{% endblock content%}